var mo;!function(b){var a;!function(c){var e=function(h){function f(){h.apply(this,arguments)}__extends(f,h);var i=(__define,f),g=i.prototype;return g._initProp=function(){h.prototype._initProp.call(this);var j=this;j.type=1,j.npcIndex=0,j.toSave=!0,j.option={}},g.set=function(l,j,m){var k=this;null!=j&&(k[l]=m?!!j:j)},f}(egret.Emitter);c.CmdCfg=e,egret.registerClass(e,"mo.GUIDE.CmdCfg");var d=function(k){function h(){k.apply(this,arguments)}__extends(h,k);var g=__define,f=h,j=f.prototype;return g(j,"id",function(){return this.cfg.id}),g(j,"grpId",function(){var i=this.id.split("_");return parseInt(i[0])}),g(j,"cmdIndex",function(){var i=this.id.split("_");return parseInt(i[1])}),j._doBaseCondition=function(){return !0},j.canExec=function(o){var p=this;if(p.mgr.paused||!o||!o.activated||!p.mgr.doBaseCondition(p)){return !1}if(p.layer=o,c.handlerMgr.handle(p.cfg,"condition",p)&&p._handleActions()){return !0}if(p._execing){var m=p.mgr,l=p.cfg;p.close(),p._execing=!1,m.initCmd(l.id,!1),p.doDtor()}return !1},j._onAction=function(){var i=this;i.actionState=2,i.exec(i.mgr.getLayer(i.cfg.layer))},j._handleActions=function(){var l=this;if(2==l.actionState){return !0}if(1==l.actionState){return !1}var i=c.handlerMgr.handle(l.cfg,"actions",l,!1);return i===!0||null==i?!0:(l.actionState=1,l._actionListened||(l._actionListened=i,b.emitter.on(i,l._onAction,l)),!1)},j._show=function(){var i=this;i._execing||(i._doingStopTouch||(b.utils.stopTouch(),i._doingStopTouch=!0),c.handlerMgr.handleAsync(i.cfg,"beforeShow",i,function(n){if(n){"string"==typeof n&&(n=[n]);var m=i.mgr;if(i.close(),n instanceof Array){for(var l=0;l<n.length;++l){m.initCmd(n[l],!1)}}}else{if(!i._handlePause()&&!i._execing){i._execing=!0;var p=i.mgr.getUIClass(i.cfg.type);i.ui=p.create().setData({cmd:i}).show(),i._doingStopTouch&&(b.utils.resumeTouch(),i._doingStopTouch=!1),c.handlerMgr.handle(i.cfg,"afterShow",i)}}}))},j._handlePause=function(){var m=this,i=m.mgr,o=m.id;if(i.paused){m.close();var l=i._recovers;return l.indexOf(o)<0&&l.push(o),!0}return !1},j.exec=function(l){var i=this;i.canExec(l)&&i._show()},j.doNext=function(){var i=this;if(i._execing){var l=i.cfg;c.handlerMgr.handleAsync(l,"beforeNext",i,function(){if(!i._handlePause()&&i._execing){i._execing=!1;var q=l.route,n=i.ui;if(q){n.visible=!1;var m=i.mgr.net,t=function(){m.unRouteSuccess(q,t,null),m.unRouteError(q,p,null),n.close(),i.mgr.gotoNext(i),c.handlerMgr.handle(l,"afterNext",i)},p=function(){m.unRouteSuccess(q,t,null),m.unRouteError(q,p,null),i.close(),i.mgr.initCmd(i.id)};m.onRouteSuccess(q,t,null),m.onRouteError(q,p,null)}else{n.close(),i.mgr.gotoNext(i),c.handlerMgr.handle(l,"afterNext",i)}}})}},j.close=function(){var l=this,i=l.ui;i&&i.close(),delete l.mgr.cmdMap[l.id],l.doDtor()},j._onActivated=function(o){var q=this,p=q.cfg.layer,m=q._onInactivated,l=b.inactivatedEmitter;l.un(p,m,q),l.on(p,m,q),q.exec(o)},j._onInactivated=function(o){var q=this,p=q.cfg.layer;if(b.inactivatedEmitter.un(p,q._onInactivated,q),q._execing){var m=q.mgr,l=q.cfg;q.close(),q._execing=!1,m.initCmd(l.id,!1),q.doDtor()}},j._onRefreshEvent=function(){this.exec(this.mgr.getLayer(this.cfg.layer))},j.initEvents=function(){var i=this,m=i.cfg.layer,l=i.cfg.refreshEvent;b.activatedEmitter.on(m,i._onActivated,i),!i._refreshEventListened&&l&&(i._refreshEventListened=!0,b.emitter.on(l,i._onRefreshEvent,i))},j.rmEvents=function(){var i=this,m=i.cfg.layer,l=i.cfg.refreshEvent;i._actionListened&&b.emitter.un(i._actionListened,i._onAction,i),b.activatedEmitter.un(m,i._onActivated,i),l&&(b.emitter.un(l,i._onRefreshEvent,i),i._refreshEventListened=!1)},j._onBeforeLayerVisible=function(){},j._onAfterLayerVisible=function(i){i.sender},j.dtor=function(){k.prototype.dtor.call(this);var i=this;i.rmEvents(),i._doingStopTouch&&(b.utils.resumeTouch(),i._doingStopTouch=!1)},j.getNode=function(){var o=this,m=o.cfg,l=c.handlerMgr.handle(m,"node",o,!1);return l?"object"==typeof l?l:b.gui.helper.getChild(o.layer,l):null},j.getRectNode=function(){var o=this,m=o.cfg,l=c.handlerMgr.handle(m,"rectNode",o,!1);return l?"object"==typeof l?l:b.gui.helper.getChild(o.layer,l):o.getNode()},h}(egret.Emitter);c.Cmd=d,egret.registerClass(d,"mo.GUIDE.Cmd")}(a=b.GUIDE||(b.GUIDE={}))}(mo||(mo={}));var mo;!function(b){var a;!function(c){var e=function(g){function j(){g.apply(this,arguments)}__extends(j,g);var h=(__define,j),f=h.prototype;return f._initProp=function(){g.prototype._initProp.call(this);var i=this;i._handlers={}},f._getInfo=function(z,p){var k=this._handlers[p];if(k){var v=z.split(":"),x=k._map[v[0]];if(x){var m=[],A=v[1];if(null!=A){for(var y=A.split(","),w=0,q=y.length;q>w;w++){m.push(b.STR.parseNumOrStr(y[w]))}}return{func:x.func,ctx:x.ctx,params:m}}}return null},f.handle=function(q,m,u,p){void 0===p&&(p=!0);var l=this,k=q[m];if(!k){return p?!0:null}var s=l._getInfo(k,m);return s?s.func.call(s.ctx,s.params,u):p?!0:k},f.handleAsync=function(q,m,u,p){var l=this,k=q[m];if(!k){return p()}var s=l._getInfo(k,m);return s?s.func.call(s.ctx,s.params,u,p):void 0},f.set=function(k,i){this._handlers[k]=i},j}(egret.Emitter);c.HandlerMgr=e,egret.registerClass(e,"mo.GUIDE.HandlerMgr"),c.handlerMgr=new e;var d=function(h){function f(){h.apply(this,arguments)}__extends(f,h);var i=(__define,f),g=i.prototype;return g._initProp=function(){h.prototype._initProp.call(this),this._map={}},g.set=function(k,j,l){this._map[k]={func:j,ctx:l}},g.get=function(j){return this._map[j]},g.handle=function(l,j){var m=this,k=m._map[l];return k?k.func.call(k.ctx,j):!0},f}(egret.Emitter);c.CfgHandler=d,egret.registerClass(d,"mo.GUIDE.CfgHandler")}(a=b.GUIDE||(b.GUIDE={}))}(mo||(mo={}));var mo;!function(b){var a;!function(c){var d=function(f){function h(){f.apply(this,arguments)}__extends(h,f);var g=(__define,h),e=g.prototype;return e._initProp=function(){f.prototype._initProp.call(this);var i=this;i._trayName="guide",i.penetrable=!1,i.touchEnabled=!1,i._touchNames=[],i._layerOpt.activateUnderDisabled=!0},e._childrenCreated=function(){f.prototype._childrenCreated.call(this);var m=this,l=m._layerOpt.rect;l.touchEnabled=!1,l.touchChildren=!1;var k=m.data.cmd;m._onTouch({name:"mask",ui:m,targetGetter:m._getRect,targetGetterCtx:m,listeners:null,isMask:!0});var j=m.grp_btn;j&&(m._initEvents_btn(),j.x=j.y=-10000),k.cfg.isHook&&b.tick(m._setBtnPos,m)},e._setBtnPos=function(){var k=this,i=k.data.cmd,l=i.getRectNode();if(l){var j=l.localToGlobal(l.width/2,l.height/2);k.grp_btn.x=j.x,k.grp_btn.y=j.y}},e._getRect=function(){return this._layerOpt.rect},e.dataChanged=function(){f.prototype.dataChanged.call(this);var i=this;i._setBtnPos()},e._initEvents_btn=function(){var m=this,k=egret.TouchEvent,o=m.data.cmd,l=m.grp_btn;l.hitTestPoint=function(){return !1},l.hitTest=function(){return null};var j={};j[k.TOUCH_BEGIN]=m._onTargetBegin,j[k.TOUCH_END]=m._onTargetEnd,m._onTouch({name:"tap",ui:m,targetGetter:o.getRectNode,targetGetterCtx:o,listeners:j,isMask:!1})},e._onTargetTap=function(){var j=this,i=j.data.cmd,k=j._target;k&&(j._target=null,k.removeEventListener(egret.TouchEvent.TOUCH_TAP,j._onTargetTap,j)),i.doNext()},e._onTargetBegin=function(){var j=this,i=j.data.cmd,k=i.getNode();j._isTargetBegin=!0,k&&(j._target=k,k.addEventListener(egret.TouchEvent.TOUCH_TAP,j._onTargetTap,j))},e._onTargetEnd=function(){var j=this,i=j._target,k=j._isTargetBegin;j._isTargetBegin=!1,k&&(i||j.data.cmd.doNext(),process.nextTick(function(){var l=j._target;l&&(l.removeEventListener(egret.TouchEvent.TOUCH_TAP,j._onTargetTap,j),j._target=null)}))},e._onTouch=function(i){var k=i.name,j=this._touchNames;j.indexOf(k)<0&&j.push(k),b.GUIDE.onTouch(i)},e.dtor=function(){f.prototype.dtor.call(this);for(var p=this,l=p._touchNames,k=0,j=l.length;j>k;k++){b.GUIDE.unTouch({name:l[k],ui:p})}var m=p._target;m&&(m.removeEventListener(egret.TouchEvent.TOUCH_TAP,p._onTargetTap,p),p._target=null),b.clearTick(p._setBtnPos,p)},h}(b.gui.Layer);c.GuideLayer=d,egret.registerClass(d,"mo.GUIDE.GuideLayer")}(a=b.GUIDE||(b.GUIDE={}))}(mo||(mo={}));var egret;!function(b){var a;!function(c){c.guideEnabled=!0,c.registerValueHandler(function(d){c.setValue(d,"guideEnabled",!0)})}(a=b.project||(b.project={}))}(egret||(egret={}));var mo;!function(b){var a;!function(e){function g(p){for(var k=0,h=e._touchOpts.length;h>k;k++){var l=e._touchOpts[k];if(l.name==p.name&&l.ui==p.ui){e._touchOpts.splice(k,1);break}}if(e._touchOpts.push(p),!d){d=!0;var j=egret.MainContext.instance.stage,i=egret.TouchEvent,m=function(u){for(var q=u.type,w=e._touchOpts,C=!1,t=w.length-1;t>=0;t--){var D=w[t];if(!D.isMask){var B=D.types;if(!(B&&B.indexOf(q)<0)){var v=D.targetGetter.call(D.targetGetterCtx);if(q!=i.TOUCH_MOVE||D.movable||u.stopImmediatePropagation(),v&&b.gui.helper.isIn(v,u.stageX,u.stageY)){C=!0,b.debug("isIn");var A=D.listeners||{},y=A[q];y&&y.call(D.ui);break}}}}if(!C){for(var t=w.length-1;t>=0;t--){var D=w[t];if(D.isMask){var B=D.types;if(!(B&&B.indexOf(q)<0)){var v=D.targetGetter.call(D.targetGetterCtx);if(v){var z=D.ui,x=z.get("cmd");if(!x.cfg.penetrable&&b.gui.helper.isIn(v,u.stageX,u.stageY)){}}}}}}};j.addEventListener(i.TOUCH_BEGIN,m,null,!0),j.addEventListener(i.TOUCH_MOVE,m,null,!0),j.addEventListener(i.TOUCH_END,m,null,!0),j.addEventListener(i.TOUCH_TAP,m,null,!0)}}function f(k){for(var l=0,j=e._touchOpts.length;j>l;l++){var h=e._touchOpts[l];if(h.name==k.name&&h.ui==k.ui){return void e._touchOpts.splice(l,1)}}}var d=!1;e._touchMap={},e._touchOpts=[],e.onTouch=g,e.unTouch=f;var c=function(l){function k(){l.apply(this,arguments)}__extends(k,l);var j=(__define,k),h=j.prototype;return h._initProp=function(){l.prototype._initProp.call(this);var i=this;i._uiClassMap={},i.cmdMap={},i._recovers=[],b.emitter.on("pauseGuide",i._onPause,i),b.emitter.on("resumeGuide",i._onResume,i)},h.registerUI=function(m,i){this._uiClassMap[m]=i},h.getUIClass=function(i){return this._uiClassMap[i]},h.initCmd=function(u,w){void 0===w&&(w=!0);var t=this;if(!t.finished&&!t.cmdMap[u]){var p=t.parser.parse(u);if(p){var m=null,v=p.revert;if(w){if("n"==v){return t.setCmd(p)}if(!v){var q=u.split("_")[0]+"_0";return u==q?t.setCmd(p):void t.initCmd(q)}m=e.handlerMgr.handle(p,"revert",null,!1),m?t.initCmd(m,!1):t.setCmd(p)}else{t.setCmd(p)}}}},h.setCmd=function(q){var s=this;if(!s.cmdMap[q.id]){var p=e.handlerMgr.handle(q,"judge",null,!1);if(p===!0||null==p){var o=new e.Cmd;o.mgr=s,o.cfg=q,s.cmdMap[q.id]=o;var m=s.getLayer(q.layer);o.initEvents(),o.exec(m)}else{p===!1||p!=q.id&&s.initCmd(p,!1)}}},h.gotoNext=function(v){var q,m=this,t=v.cfg,x=v.grpId,p=v.cmdIndex,z=t.next;delete m.cmdMap[t.id],v.doDtor(),z&&(z=e.handlerMgr.handle(t,"next",null,!1)),z&&(q=m.parser.parse(z),q||(z=e.handlerMgr.handle(t,"next",v,!1),z&&(q=m.parser.parse(z)))),q||(z=x+"_"+(p+1),q=m.parser.parse(z)),q||(z=x+1+"_0",q=m.parser.parse(z));var y;if(q?(m.setCmd(q),q.toSave&&(y=z)):t.toSave&&(y=t.id.split("_")[0]+"_10000"),y){var w={};w[m.route_arg_key]=y,m.net.request4Server(m.route,w,function(){},null)}},h._getLayer=function(q,x){var v=b.utils.getChildren(x);if(0==v.length){return null}for(var p=0,m=v.length;m>p;p++){var w=v[p];if(w.__className==q){return w}}for(var p=0,m=v.length;m>p;p++){var u=this._getLayer(q,v[p]);if(u){return u}}return null},h.getLayer=function(i){return this._getLayer(i,b.gui.uiScene)||this._getLayer(i,b.gui.infoScene)},h.onBaseCondition=function(i){this._onBaseCondition=i},h.doBaseCondition=function(i){return this._onBaseCondition?this._onBaseCondition(i):!0},h._onPause=function(){var w=this;w.paused=!0;var q=w.cmdMap,y=Object.keys(q),v=w._recovers;v.length=0;for(var p=0,m=y.length;m>p;++p){var x=y[p],u=q[x];u._execing&&(u.close(),v.push(x))}},h._onResume=function(){var u=this,q=u._recovers;u.paused=!1;for(var w=0,s=q.length;s>w;++w){u.initCmd(q[w],!1)}var p=u.cmdMap;for(var m in p){if(q.indexOf(m)<0){var v=p[m];v.exec(u.getLayer(v.cfg.layer))}}q.length=0},h.dtor=function(){l.prototype.dtor.call(this);var i=this;b.emitter.un("pauseGuide",i._onPause,i),b.emitter.un("resumeGuide",i._onResume,i)},k}(egret.Emitter);e.Mgr=c,egret.registerClass(c,"mo.GUIDE.Mgr"),e.mgr=new c}(a=b.GUIDE||(b.GUIDE={}))}(mo||(mo={}));